#!/bin/bash

################################################################################
# Script de Configura√ß√£o de Firewall para Inst√¢ncias EC2
# Autor: Laborat√≥rio DIO - AWS EC2
# Descri√ß√£o: Configura regras de firewall local (iptables/ufw/firewalld)
#            seguindo as melhores pr√°ticas de seguran√ßa
# Uso: sudo ./setup-firewall.sh
################################################################################

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Fun√ß√£o para imprimir mensagens coloridas
print_message() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERRO]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[AVISO]${NC} $1"
}

print_title() {
    echo -e "${BLUE}$1${NC}"
}

# Verificar se est√° rodando como root
if [[ $EUID -ne 0 ]]; then
   print_error "Este script precisa ser executado como root (use sudo)"
   exit 1
fi

# Banner
echo ""
print_title "========================================================================"
print_title "     CONFIGURA√á√ÉO DE FIREWALL - AWS EC2"
print_title "     Laborat√≥rio DIO - Seguran√ßa em Nuvem"
print_title "========================================================================"
echo ""

# Detectar sistema de firewall dispon√≠vel
detect_firewall() {
    if command -v firewall-cmd &> /dev/null; then
        echo "firewalld"
    elif command -v ufw &> /dev/null; then
        echo "ufw"
    elif command -v iptables &> /dev/null; then
        echo "iptables"
    else
        echo "none"
    fi
}

FIREWALL_TYPE=$(detect_firewall)
print_message "Sistema de firewall detectado: $FIREWALL_TYPE"

# Fun√ß√£o para configurar firewalld (CentOS, RHEL, Amazon Linux 2)
configure_firewalld() {
    print_title "\nüî• Configurando firewalld..."
    
    # Iniciar e habilitar firewalld
    systemctl start firewalld
    systemctl enable firewalld
    
    # Verificar zona ativa
    ACTIVE_ZONE=$(firewall-cmd --get-active-zones | head -n 1)
    print_message "Zona ativa: $ACTIVE_ZONE"
    
    # Regras b√°sicas
    print_message "Aplicando regras b√°sicas..."
    
    # SSH (sempre necess√°rio)
    firewall-cmd --permanent --add-service=ssh
    print_message "‚úì SSH (porta 22) - PERMITIDO"
    
    # HTTP
    firewall-cmd --permanent --add-service=http
    print_message "‚úì HTTP (porta 80) - PERMITIDO"
    
    # HTTPS
    firewall-cmd --permanent --add-service=https
    print_message "‚úì HTTPS (porta 443) - PERMITIDO"
    
    # Portas customizadas (opcional)
    read -p "Deseja adicionar portas customizadas? (s/n): " ADD_CUSTOM
    if [[ $ADD_CUSTOM == "s" ]] || [[ $ADD_CUSTOM == "S" ]]; then
        read -p "Digite a porta (ex: 8080): " CUSTOM_PORT
        read -p "Protocolo (tcp/udp): " PROTOCOL
        firewall-cmd --permanent --add-port=${CUSTOM_PORT}/${PROTOCOL}
        print_message "‚úì Porta ${CUSTOM_PORT}/${PROTOCOL} - PERMITIDO"
    fi
    
    # Bloquear ping (ICMP) - opcional
    read -p "Deseja bloquear ping (ICMP)? (s/n): " BLOCK_PING
    if [[ $BLOCK_PING == "s" ]] || [[ $BLOCK_PING == "S" ]]; then
        firewall-cmd --permanent --add-icmp-block=echo-request
        print_message "‚úì ICMP (ping) - BLOQUEADO"
    fi
    
    # Recarregar firewall
    firewall-cmd --reload
    
    # Mostrar regras ativas
    print_title "\nüìã Regras Ativas:"
    firewall-cmd --list-all
}

# Fun√ß√£o para configurar UFW (Ubuntu, Debian)
configure_ufw() {
    print_title "\nüõ°Ô∏è Configurando UFW..."
    
    # Resetar regras (opcional)
    read -p "Deseja resetar regras existentes? (s/n): " RESET_RULES
    if [[ $RESET_RULES == "s" ]] || [[ $RESET_RULES == "S" ]]; then
        ufw --force reset
        print_message "Regras resetadas"
    fi
    
    # Pol√≠tica padr√£o
    print_message "Configurando pol√≠tica padr√£o..."
    ufw default deny incoming
    ufw default allow outgoing
    print_message "‚úì Pol√≠tica: DENY incoming, ALLOW outgoing"
    
    # Regras b√°sicas
    print_message "Aplicando regras b√°sicas..."
    
    # SSH (sempre necess√°rio)
    ufw allow ssh
    print_message "‚úì SSH (porta 22) - PERMITIDO"
    
    # HTTP
    ufw allow http
    print_message "‚úì HTTP (porta 80) - PERMITIDO"
    
    # HTTPS
    ufw allow https
    print_message "‚úì HTTPS (porta 443) - PERMITIDO"
    
    # Portas customizadas (opcional)
    read -p "Deseja adicionar portas customizadas? (s/n): " ADD_CUSTOM
    if [[ $ADD_CUSTOM == "s" ]] || [[ $ADD_CUSTOM == "S" ]]; then
        read -p "Digite a porta (ex: 8080): " CUSTOM_PORT
        read -p "Protocolo (tcp/udp): " PROTOCOL
        ufw allow ${CUSTOM_PORT}/${PROTOCOL}
        print_message "‚úì Porta ${CUSTOM_PORT}/${PROTOCOL} - PERMITIDO"
    fi
    
    # Limitar tentativas de SSH (prote√ß√£o contra brute force)
    read -p "Deseja limitar tentativas de conex√£o SSH? (s/n): " LIMIT_SSH
    if [[ $LIMIT_SSH == "s" ]] || [[ $LIMIT_SSH == "S" ]]; then
        ufw limit ssh
        print_message "‚úì SSH - RATE LIMITING ativado"
    fi
    
    # Habilitar UFW
    print_warning "Habilitando UFW..."
    ufw --force enable
    
    # Mostrar status
    print_title "\nüìã Status do UFW:"
    ufw status verbose
}

# Fun√ß√£o para configurar iptables (gen√©rico)
configure_iptables() {
    print_title "\nüîí Configurando iptables..."
    
    print_warning "ATEN√á√ÉO: Configura√ß√£o de iptables pode desconectar sua sess√£o SSH!"
    read -p "Deseja continuar? (s/n): " CONTINUE
    if [[ $CONTINUE != "s" ]] && [[ $CONTINUE != "S" ]]; then
        print_message "Configura√ß√£o cancelada."
        exit 0
    fi
    
    # Limpar regras existentes
    print_message "Limpando regras existentes..."
    iptables -F
    iptables -X
    iptables -Z
    
    # Pol√≠tica padr√£o
    print_message "Definindo pol√≠tica padr√£o..."
    iptables -P INPUT DROP
    iptables -P FORWARD DROP
    iptables -P OUTPUT ACCEPT
    
    # Permitir loopback
    iptables -A INPUT -i lo -j ACCEPT
    print_message "‚úì Loopback - PERMITIDO"
    
    # Permitir conex√µes estabelecidas
    iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
    print_message "‚úì Conex√µes estabelecidas - PERMITIDO"
    
    # SSH
    iptables -A INPUT -p tcp --dport 22 -j ACCEPT
    print_message "‚úì SSH (porta 22) - PERMITIDO"
    
    # HTTP
    iptables -A INPUT -p tcp --dport 80 -j ACCEPT
    print_message "‚úì HTTP (porta 80) - PERMITIDO"
    
    # HTTPS
    iptables -A INPUT -p tcp --dport 443 -j ACCEPT
    print_message "‚úì HTTPS (porta 443) - PERMITIDO"
    
    # Prote√ß√£o contra ping flood
    iptables -A INPUT -p icmp --icmp-type echo-request -m limit --limit 1/s -j ACCEPT
    print_message "‚úì ICMP - RATE LIMITED"
    
    # Prote√ß√£o contra port scanning
    iptables -A INPUT -p tcp --tcp-flags ALL NONE -j DROP
    iptables -A INPUT -p tcp --tcp-flags ALL ALL -j DROP
    print_message "‚úì Prote√ß√£o contra port scan - ATIVADO"
    
    # Salvar regras
    print_message "Salvando regras..."
    if command -v iptables-save &> /dev/null; then
        iptables-save > /etc/iptables/rules.v4 2>/dev/null || \
        iptables-save > /etc/sysconfig/iptables 2>/dev/null || \
        iptables-save > /tmp/iptables-rules.txt
        print_message "‚úì Regras salvas"
    fi
    
    # Mostrar regras
    print_title "\nüìã Regras Ativas:"
    iptables -L -n -v
}

# Fun√ß√£o para criar script de persist√™ncia
create_persistence_script() {
    print_message "\nCriando script de persist√™ncia..."
    
    cat > /usr/local/bin/restore-firewall.sh << 'EOF'
#!/bin/bash
# Script de restaura√ß√£o de firewall
# Criado automaticamente pelo setup-firewall.sh

if [ -f /etc/iptables/rules.v4 ]; then
    iptables-restore < /etc/iptables/rules.v4
elif [ -f /etc/sysconfig/iptables ]; then
    iptables-restore < /etc/sysconfig/iptables
fi
EOF
    
    chmod +x /usr/local/bin/restore-firewall.sh
    print_message "‚úì Script de persist√™ncia criado"
}

# Fun√ß√£o para verificar Security Groups AWS
check_aws_security_groups() {
    print_title "\n‚òÅÔ∏è Verifica√ß√£o de Security Groups AWS"
    print_warning "LEMBRE-SE: As regras de Security Group da AWS s√£o aplicadas ANTES do firewall local!"
    echo ""
    print_message "Certifique-se de que seu Security Group permite:"
    echo "  ‚Ä¢ SSH (porta 22) - Do seu IP"
    echo "  ‚Ä¢ HTTP (porta 80) - De 0.0.0.0/0"
    echo "  ‚Ä¢ HTTPS (porta 443) - De 0.0.0.0/0"
    echo ""
    print_message "Para verificar: AWS Console > EC2 > Security Groups"
}

# Executar configura√ß√£o baseada no tipo de firewall
case $FIREWALL_TYPE in
    "firewalld")
        configure_firewalld
        ;;
    "ufw")
        configure_ufw
        ;;
    "iptables")
        configure_iptables
        create_persistence_script
        ;;
    "none")
        print_error "Nenhum sistema de firewall detectado!"
        print_message "Instalando iptables..."
        yum install iptables-services -y 2>/dev/null || apt-get install iptables-persistent -y 2>/dev/null
        configure_iptables
        ;;
esac

# Verificar Security Groups AWS
check_aws_security_groups

# Resumo final
echo ""
print_title "========================================================================"
print_title "     ‚úÖ CONFIGURA√á√ÉO CONCLU√çDA"
print_title "========================================================================"
echo ""
print_message "Firewall configurado com sucesso!"
print_message "Sistema: $FIREWALL_TYPE"
echo ""
print_title "üìù Comandos √öteis:"
echo ""

case $FIREWALL_TYPE in
    "firewalld")
        echo "  Ver status:       sudo firewall-cmd --state"
        echo "  Listar regras:    sudo firewall-cmd --list-all"
        echo "  Adicionar porta:  sudo firewall-cmd --permanent --add-port=PORTA/tcp"
        echo "  Remover porta:    sudo firewall-cmd --permanent --remove-port=PORTA/tcp"
        echo "  Recarregar:       sudo firewall-cmd --reload"
        ;;
    "ufw")
        echo "  Ver status:       sudo ufw status verbose"
        echo "  Adicionar porta:  sudo ufw allow PORTA/tcp"
        echo "  Remover regra:    sudo ufw delete allow PORTA/tcp"
        echo "  Habilitar:        sudo ufw enable"
        echo "  Desabilitar:      sudo ufw disable"
        ;;
    "iptables")
        echo "  Ver regras:       sudo iptables -L -n -v"
        echo "  Salvar regras:    sudo iptables-save > /etc/iptables/rules.v4"
        echo "  Restaurar regras: sudo iptables-restore < /etc/iptables/rules.v4"
        echo "  Limpar regras:    sudo iptables -F"
        ;;
esac

echo ""
print_title "========================================================================"
echo ""

print_message "Script finalizado!"
exit 0